---
title: "Scots pine Site Index - first look"
author: "Wojciech Kedziora"
date: "27-10-2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::clean_cache()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
library(tidyverse)
library(tmap)
library(sp)
library(RColorBrewer)
```

# Theory
## National Forest Inventory in Poland

National Forest Inventory in Poland (*NFI*) is a comprhensive survey of forests. It ocnsists of ~28k sample plots all over the country. Plots are being gathered into so called "tracts". Tractc centres are distributed on 4x4 km grid, that have been based upon ICP Forest sample plots (Fig. 1.).

![Fig. 1. Tracts display.](D:/Praca/Badania/Doktorat/img/tracts.jpg){width=500px}

Each tract consists of five sample plots formed in L-shape. Distance between nearest ones is 200 m. Sample plots are blocked in tracts to make them more accesible and to ease the work of field brigades.

![Fig. 2. Single tract.](D:/Praca/Badania/Doktorat/img/tract.jpg){width=500px}

Each sample plot consists of two different sub-plots. Sub-plot A is bigger, concentric one. Trees thicker than 7 cm of diameter at 130 cm above ground (i.e. diameter at breast hieight - *dbh*) are being measured there. The area changes due to age of a tree stand. On B sub-plot we measure trees thiner than 7 cm *dbh* in a donut-shaped ring. It has an area of 20 m^2^.

![Fig. 3. Sample plot.](D:/Praca/Badania/Doktorat/img/sample_plot.jpg){width=500px}

## Site Index

Site Index (*SI*) is a proxy measure for soil fertility. It models height of 100 heighest trees per hactare in the age of 100 years. In Fig. 4. example tree stand has 32 years and 14 meters height. Model shows that in age of 100 years it should have 27,2 meters, thus its *SI* should be of the same value.

![Fig. 4. Site Index.](D:/Praca/Badania/Doktorat/img/site_index.jpg){width=500px}

# Practice
## Data loading

I am loading NFI data (2010-2015) about trees thicker than 7 cm *dbh* that have been prepared from MS Access DataBase.
I have subsettet only important features that will be important in later analysis.

```{r loading_trees, echo = TRUE}
trees_loading <- cols(species = col_factor(levels = NULL)) 
trees <- read_tsv("trees.txt", col_types = trees_loading)
trees
```

*plot_no* it is obviously identifier of a unique sample plot. However sample plots can be divided into subplots (*subplot_no*) -- *e.g.* when sample plot lies on the border of forest and non-forest.

*species* means what kind specimen is being recorded. In this case we are focused on Scots pine (*Pinus sylvatica* L.) which is translatd to Polish as *sosna* and abbreviated as **SO**.

*age* is self explanatory

*azimuth* and *dist* are polar coordinates that are recording exact location of sampled tree

*h* is recorded height of a tree. On each sample plot there are only one or two measurments of height for each species because it is a time consuming operation.  

*dbh* is mentioned previously, diameter at breast height, *i.e.* 130 cm above ground.

## Data summary

First of all, I am interested in distribution of tree heights among the data.

```{r trees-histogram, warning = FALSE}
ggplot(trees, aes(h)) + geom_freqpoly(binwidth = 1)
```

One can see that the data is not similar to normal distribution. However those are heights from all trees, not only Scots pine.

```{r trees-boxplot, warning = FALSE}
ggplot(trees, aes(x = "", y = h)) + geom_boxplot()
```

We have some outliers in upper tail. Up to 45 meters. That is quite high, probably this is not pine (it is not growing that high).

Let me check that:

```{r pine_height_checking}
trees %>%
  dplyr::filter(species == "SO") %>%
  dplyr::arrange(desc(h))
```

As I have thought, the heighest pine tree is 38 meters tall, which is quite a good result. Later I may check where it is growing.

So maybe instead of checking all species I will focus myself on Scots pine.

```{r pine_trees_select}
trees %>%
  dplyr::filter((species == "SO")) -> pine_trees
```

Gong again through histogram: 

```{r pine_trees_histogram, warning = FALSE}
ggplot(pine_trees, aes(h)) + geom_freqpoly(binwidth = 1)
```

Still not perfect.

Boxplot:
```{r pine_trees_boxplot, warning = FALSE}
ggplot(pine_trees, aes(x = "", y = h)) + geom_boxplot()
```

And qq-norm graph:
```{r pine_trees_qqnorm, warning = FALSE}
ggplot(pine_trees, aes(sample = h)) + stat_qq()
```

Empirical cumulative distribution:
```{r pine_trees_ecdf, warning = FALSE}
ggplot(pine_trees, aes(h)) + stat_ecdf(geom = "step")
```

Basic summary:
```{r pine_trees_summary}
summary(pine_trees$h, na.rm = TRUE)
```

One can see that there are many NA's, but it is only bacuse of sample design.

Now I would like to comaper how many unique heights are there on every sample plot:
```{r unique_h_on_sample_plot}
trees %>%
  dplyr::filter(!is.na(h)) %>%
  dplyr::group_by(subplot_no) %>%
  dplyr::summarise(n = n_distinct(h)) %>%
  dplyr::group_by(n) %>%
  dplyr::summarise(z = n_distinct(subplot_no)) %>%
  ggplot(aes(n, z)) +
  geom_bar(stat = "identity")
```

The number of heights being measured depends on canopy layers in the forest, number of diferent tree species and their age. If there is only one species of similar age and in one layer in a tree stand then we measure only two heights. But if there are other then we nedd to measure at least one height.

How is the situation in pine subsample: 
```{r unique_pine_h_on_sample_plot}
pine_trees %>%
  dplyr::filter(!is.na(dbh)) %>%
  dplyr::filter(!is.na(h)) %>%
  dplyr::group_by(subplot_no) %>%
  dplyr::summarise(n = n_distinct(h)) %>%
  dplyr::group_by(n) %>%
  dplyr::summarise(z = n_distinct(subplot_no)) %>%
  ggplot(aes(n, z)) +
  geom_bar(stat = "identity")
```

Mostly we have two samples, therefore we can assume that it is a pure pine stand of uniform age and horizontal layer. Why four different heights? We can have two different layer: top canopy layer of an age of 120 years and second layer, smaller of trees in their sixties.

## Site Index calculation

Now lets move to site index calculation. First we need to put in some variables for the model:
```{r variables_for_site_index}
values <- tibble(b1 = 1.381, b3 = 32.947, b2 = 4679.9)
```

Next we move to calculation itself:
```{r site_index_computation, cache = TRUE}
pine_trees %>%
  dplyr::group_by(plot_no, subplot_no) %>% # we group them by plots because we want to compute SI for every plot
  dplyr::summarise(
    H = weighted.mean(h, dbh, na.rm = TRUE), # we want to have mean height of the tree stand
    age = mean(age), # still not sure if it's the best idea
    SI = H * ((100 ^ values$b1) * ((age ^ values$b1) * (H - values$b3 + (((H - values$b3) ^ 2) + 
         (2 * values$b2 * H) / (age ^ values$b1)) ^ 0.5) + values$b2)) / ((age ^ values$b1) * 
         ((100 ^ values$b1) * (H - values$b3 + (((H - values$b3) ^ 2) + (2 * values$b2 * H)
         /(age ^ values$b1)) ^ 0.5) + values$b2))) %>% 
  dplyr::arrange(desc(SI)) -> site_index
```

## Site Index summary

Now we can sumamrize site index in similar way as with heights.

Firstly we will add sample plot area data to get rid of smallest, and probably ciased, sample plots:
```{r area_filtering}
### join with area data ----
area <- read_tsv("area.txt")
site_index_area_unfiltered <- dplyr::left_join(site_index, area, by = "subplot_no") %>% na.omit()

# main assumption is that on small areas <200m^2 is not enough trees to get proper measurments
site_index_area_unfiltered %>% dplyr::filter(area >= 200) -> site_index_area
```

```{r site_index_summary}
ggplot(site_index_area, aes(SI)) + geom_freqpoly(binwidth = 1)
ggplot(site_index_area, aes(x = "", y = SI)) + geom_boxplot()
ggplot(site_index_area, aes(sample = SI)) + stat_qq()
ggplot(site_index_area, aes(SI)) + stat_ecdf(geom = "step")
summary(site_index_area$SI, na.rm = TRUE)
```

Site index distribution in mote likely to be normally distributed.

I am not strictly sure about this test, but Shapiroo-Wilk has limit to 5000 samples. On the other hand I have read that normality testing for big samples almost always (even if data is normal) rejects the null hypothesis. What one should do?
```{r height_normality_test}
ks.test(x = site_index$H, y = 'pnorm', alternative = 'two.sided')
```
 There is a warning about repeated values.
 
 ## Site Index map

Finally I wanted to draw a first-look map to have some idea how the data is spatially distributed.

```{r site_index_map}
library(raster)
library(sp)
gps_coord <- read_tsv("gps_coord.txt")
site_index_area_gps <- dplyr::left_join(site_index_area, gps_coord, by = "plot_no") %>% na.omit()

coordinates(site_index_area_gps) <- ~ lon + lat #adding sptial relationship
proj4string(site_index_area_gps) <- "+init=epsg:4326" #adding WGS84 projection

# site index map plotting -----
data(Europe, rivers)
vistula <- subset(rivers, name == "Vistula")
tm_shape(Europe, bbox = "Poland", projection="longlat", is.master = TRUE) + 
  tm_borders() +
  tm_shape(vistula) + 
  tm_lines(col = "steelblue", lwd = 4) +
  tm_shape(site_index_area_gps) +
  tm_dots(col = "SI", size = 0.05) +
  tm_style_white(legend.position = c("left", "bottom"))
```

